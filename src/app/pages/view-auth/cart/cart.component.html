<main>

  <!-- breadcrumb area start -->
  <section class="breadcrumb__area include-bg pt-95 pb-50">
     <div class="container">
        <div class="row">
           <div class="col-xxl-12">
              <div class="breadcrumb__content p-relative z-index-1">
                 <h3 class="breadcrumb__title">Carrito de compra</h3>
                 <div class="breadcrumb__list">
                    <span><a href="#">Home</a></span>
                    <span>Carrito de compra</span>
                 </div>
              </div>
           </div>
        </div>
     </div>
  </section>
  <!-- breadcrumb area end -->

  <!-- cart area start -->
  <section class="tp-cart-area pb-120">
     <div class="container">
        <div class="row">
           <div class="col-xl-9 col-lg-8">
              <div class="tp-cart-list mb-25 mr-30">
                 <table class="table">
                    <thead>
                      <tr>
                        <th colspan="2" class="tp-cart-header-product">Producto</th>
                        <th class="tp-cart-header-price">Precio</th>
                        <th class="tp-cart-header-quantity">Cantidad</th>
                        <th class="tp-cart-header-price">Total</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let cart of listCarts">
                        <ng-container *ngIf="cart.id !== 'SHIPPING'">
                           <!-- img -->
                           <td class="tp-cart-img">
                             <a [routerLink]="['/producto/'+cart.product.slug]">
                               <img [src]="cart.product.imagen" alt="">
                             </a>
                           </td>

                           <!-- title -->
                           <td class="tp-cart-title">
                             <a [routerLink]="['/producto/'+cart.product.slug]">
                               {{cart.product.title}}
                             </a>

                             <!-- Aviso de envío gratis por producto -->
                             <ng-container *ngIf="cart.product && cart.product.cost == 1">
                               <br>
                               <span class="badge bg-success" style="font-size: 0.85rem; margin-top: 5px;">✓ Envío GRATIS</span>
                             </ng-container>

                             <!-- ✅ DEBUG: Mostrar valores de stock -->
<!-- <div *ngIf="cart.stock_disponible !== null && cart.stock_disponible !== undefined">
  <small class="text-muted">
    Stock disponible: {{cart.stock_disponible}} |
    Stock suficiente: {{cart.stock_suficiente}} |
    Cantidad: {{cart.quantity}}
  </small>
</div> -->

                             <!-- ✅ INDICADOR DE STOCK -->
                             <ng-container *ngIf="!cart.stock_suficiente">
                               <br>
                               <div class="alert alert-warning stock-alert" style="margin-top: 8px; padding: 8px 12px; font-size: 0.9rem; max-width: 400px;">
                                 <i class="fas fa-exclamation-triangle"></i>
                                 <span *ngIf="cart.stock_disponible === 0">
                                   <strong>Sin stock disponible</strong>
                                 </span>
                                 <span *ngIf="cart.stock_disponible > 0">
                                   Solo quedan <strong>{{cart.stock_disponible}}</strong> unidades disponibles
                                 </span>
                               </div>
                             </ng-container>

                             <div style="margin-left: 20px;">
                               <ng-container *ngIf="cart.product_variation">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• {{cart.product_variation.attribute.name}}: {{cart.product_variation.propertie?.name || cart.product_variation.value_add}}</span>
                                 <ng-container *ngIf="cart.product_variation.variation_father">
                                   <br>
                                   <span class="cartmini__quantity mx-2">• {{cart.product_variation.variation_father.attribute.name}}: {{cart.product_variation.variation_father.propertie?.name || cart.product_variation.variation_father.value_add}}
                                   </span>
                                 </ng-container>
                               </ng-container>
                               <ng-container *ngIf="cart.code_cupon">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• Cupon: {{cart.code_cupon}}</span>
                               </ng-container>
                               <ng-container *ngIf="cart.code_discount">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• Campaña: {{cart.code_discount}}</span>
                               </ng-container>
                               <ng-container *ngIf="cart.code_discount || cart.code_cupon">
                                 <br>
                                 <span class="text-primary mx-2">• Descuento:{{cart.discount}} {{cart.type_discount == 1 ? '%' : cart.currency}}</span>
                                 <br>
                                 <span class="text-danger mx-2">• Precio original: <del>{{cart.price_unit}}</del></span>
                               </ng-container>
                             </div>
                           </td>

                           <!-- price -->
                           <td class="tp-cart-price"><span>{{cart.subtotal}} {{cart.currency}}</span></td>

                           <!-- quantity -->
                           <td class="tp-cart-quantity">
                              <div class="tp-product-quantity mt-10 mb-10">
                                 <span class="tp-cart-minus"
                                       (click)="minusQuantity(cart)"
                                       [class.disabled]="!cart.stock_suficiente">
                                    <svg width="10" height="2" viewBox="0 0 10 2" fill="none" xmlns="http://www.w3.org/2000/svg">
                                       <path d="M1 1H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                 </span>
                                 <input class="tp-cart-input" type="text" [value]="cart.quantity" readonly>
                                 <span class="tp-cart-plus"
                                       (click)="plusQuantity(cart)"
                                       [class.disabled]="!cart.stock_suficiente || cart.quantity >= cart.stock_disponible">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                       <path d="M5 1V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                       <path d="M1 5H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                 </span>
                              </div>
                           </td>

                           <td class="tp-cart-price"><span>{{cart.total}} {{cart.currency}}</span></td>

                           <!-- action -->
                           <td class="tp-cart-action">
                              <button class="tp-cart-action-btn" (click)="deleteCart(cart)">
                                 <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.53033 1.53033C9.82322 1.23744 9.82322 0.762563 9.53033 0.46967C9.23744 0.176777 8.76256 0.176777 8.46967 0.46967L5 3.93934L1.53033 0.46967C1.23744 0.176777 0.762563 0.176777 0.46967 0.46967C0.176777 0.762563 0.176777 1.23744 0.46967 1.53033L3.93934 5L0.46967 8.46967C0.176777 8.76256 0.176777 9.23744 0.46967 9.53033C0.762563 9.82322 1.23744 9.82322 1.53033 9.53033L5 6.06066L8.46967 9.53033C8.76256 9.82322 9.23744 9.82322 9.53033 9.53033C9.82322 9.23744 9.82322 8.76256 9.53033 8.46967L6.06066 5L9.53033 1.53033Z" fill="currentColor"/>
                                 </svg>
                                 <span><br>Eliminar</span>
                              </button>
                           </td>
                        </ng-container>
                      </tr>
                    </tbody>
                  </table>
              </div>

              <!-- ✅ MENSAJE DE ADVERTENCIA GENERAL DE STOCK -->
              <div *ngIf="hasStockIssues" class="alert alert-danger mb-4" style="padding: 15px; border-radius: 5px;">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Atención:</strong> Algunos productos en tu carrito no tienen stock suficiente.
                Por favor actualiza las cantidades o elimínalos para continuar con la compra.
              </div>

              <!-- Detalle del cupón y resumen intermedio -->
              <div class="card p-3 mb-4">
                <div *ngIf="globalCouponCode || discountTotal > 0" class="mb-2">
                  <div><strong>Cupon:</strong> {{ globalCouponCode }}</div>
                  <div *ngIf="discountTotal > 0">• <strong>Descuento:</strong> {{ discountTotal }} {{ currency }}</div>
                  <div>• <strong>Precio original:</strong> <del>{{ subtotalOriginal }} {{ currency }}</del></div>
                </div>
                <div *ngIf="!globalCouponCode && discountTotal == 0" class="text-muted">No hay cupones aplicados</div>
              </div>

              <div class="tp-cart-bottom">
                 <div class="row align-items-end">
                    <div class="col-xl-6 col-md-8">
                       <div class="tp-cart-coupon">
                          <form action="#">
                             <div class="tp-cart-coupon-input-box">
                                <label>Cupon:</label>
                                <div class="tp-cart-coupon-input d-flex align-items-center">
                                   <input type="text" name="code_cupon" [(ngModel)]="code_cupon" placeholder="Colocar codigo del cupon">
                                   <button type="button" (click)="applyCupon()">Aplicar</button>
                                </div>
                             </div>
                          </form>
                       </div>
                    </div>
                 </div>
              </div>
           </div>

           <div class="col-xl-3 col-lg-4 col-md-6">
              <div class="tp-cart-checkout-wrapper">
                  <div class="tp-cart-checkout-top d-flex align-items-center justify-content-between">
                    <span class="tp-cart-checkout-top-title">Subtotal: </span>
                    <span class="tp-cart-checkout-top-price">${{subtotalAfterDiscount}} {{currency}}</span>
                  </div>

                  <div *ngIf="globalCouponCode || discountTotal > 0" class="p-2">
                   <div>Cupon: <strong>{{ globalCouponCode }}</strong></div>
                   <div *ngIf="discountTotal > 0">Descuento: <strong>{{ discountTotal }} {{ currency }}</strong></div>
                   <div>Precio original: <del>{{ subtotalOriginal }} {{ currency }}</del></div>
                  </div>

                 <div class="tp-cart-checkout-shipping">
                  <h4 class="tp-cart-checkout-shipping-title">Envio</h4>

                  <!-- Mensaje de envío gratis -->
                  <div *ngIf="hasFreeShipping" class="alert alert-success mb-3">
                    <strong>¡Envío GRATIS!</strong> Todos los productos en tu carrito tienen envío gratis.
                  </div>

                  <!-- Mensaje mixto (algunos productos con envío gratis) -->
                  <div *ngIf="hasSomeFreeShipping && !hasFreeShipping" class="alert alert-info mb-3">
                    <strong>Nota:</strong> Algunos productos tienen envío gratis, pero otros no.
                  </div>

                  <!-- Formulario de provincia (solo si NO todos tienen envío gratis) -->
                  <form *ngIf="!hasFreeShipping" #provinciaForm="ngForm" (ngSubmit)="applyCosto()">
                    <label for="provincia">Seleccionar provincia:</label>
                    <div class="d-flex align-items-center">
                      <select
                        [(ngModel)]="selectedProvinceCode"
                        name="provincia"
                        id="provincia"
                        required
                        class="form-select"
                        #provinciaControl="ngModel"
                      >
                        <option [ngValue]="null" disabled>-- SELECCIONAR --</option>
                        <option *ngFor="let prov of provincias" [ngValue]="prov.code">
                          {{ prov.name }}
                        </option>
                      </select>

                      <button
                        type="submit"
                        class="btn btn-primary ms-2"
                        [disabled]="provinciaForm.invalid"
                      >
                        Aplicar
                      </button>

                      <button
                        *ngIf="selectedProvinceCode"
                        type="button"
                        (click)="removeProvincia()"
                        class="btn btn-danger ms-2"
                      >
                        <span aria-hidden="true">×</span>
                      </button>
                    </div>

                    <div *ngIf="provinciaControl.invalid && provinciaControl.touched" class="text-danger mt-1">
                      La provincia es obligatoria.
                    </div>

                    <div *ngIf="costoEnvio !== null && costoEnvio > 0" class="mt-2">
                      <span class="cartmini__quantity mx-2">• Costo de envío: {{ costoEnvio }} {{ currency }}</span>
                    </div>
                  </form>
                </div>

                <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                  <span>Subtotal</span>
                  <span>{{ subtotalAfterDiscount }} {{ currency }}</span>
                </div>

                <div *ngIf="shippingCostValue > 0" class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                  <span>Envío</span>
                  <span>{{ shippingCostValue }} {{ currency }}</span>
                </div>

                <!-- Mostrar envío gratis si aplica -->
                <div *ngIf="hasFreeShipping" class="tp-cart-checkout-total d-flex align-items-center justify-content-between text-success">
                  <span>Envío</span>
                  <span><strong>GRATIS</strong></span>
                </div>

                <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                  <span><strong>Total</strong></span>
                  <span><strong>{{ grandTotal }} {{ currency }}</strong></span>
                </div>

                <!-- ✅ BOTÓN DE CHECKOUT CON VALIDACIÓN DE STOCK -->
                <div class="tp-cart-checkout-proceed">
                  <button
                    class="tp-cart-checkout-btn w-100"
                    (click)="proceedToCheckout()"
                    [disabled]="hasStockIssues || (!hasFreeShipping && !selectedProvinceCode) || listCarts.length === 0"
                    [ngClass]="{'disabled-btn': hasStockIssues || (!hasFreeShipping && !selectedProvinceCode) || listCarts.length === 0}"
                  >
                    <span *ngIf="!hasStockIssues">Ir al checkout</span>
                    <span *ngIf="hasStockIssues">Stock insuficiente</span>
                  </button>

                  <!-- Mensajes de validación -->
                  <div *ngIf="hasStockIssues" class="text-danger text-center mt-2">
                    <i class="fas fa-exclamation-circle"></i>
                    No puedes continuar debido a problemas de stock.
                  </div>

                  <div *ngIf="!hasStockIssues && !hasFreeShipping && !selectedProvinceCode" class="text-danger text-center mt-2">
                    Debes seleccionar una provincia antes de continuar.
                  </div>
                </div>

              </div>
           </div>
        </div>
     </div>
  </section>
  <!-- cart area end -->

</main>
