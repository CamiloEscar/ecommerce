<main>

  <!-- breadcrumb area start -->
  <section class="breadcrumb__area include-bg pt-95 pb-50">
     <div class="container">
        <div class="row">
           <div class="col-xxl-12">
              <div class="breadcrumb__content p-relative z-index-1">
                 <h3 class="breadcrumb__title">Carrito de compra</h3>
                 <div class="breadcrumb__list">
                    <span><a href="#">Home</a></span>
                    <span>Carrito de compra</span>
                 </div>
              </div>
           </div>
        </div>
     </div>
  </section>
  <!-- breadcrumb area end -->

  <!-- cart area start -->
  <section class="tp-cart-area pb-120">
     <div class="container">
        <div class="row">
           <div class="col-xl-9 col-lg-8">
              <div class="tp-cart-list mb-25 mr-30">
                 <table class="table">
                    <thead>
                      <tr>
                        <th colspan="2" class="tp-cart-header-product">Producto</th>
                        <th class="tp-cart-header-price">Precio</th>
                        <th class="tp-cart-header-quantity">Cantidad</th>
                        <th class="tp-cart-header-price">Total</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let cart of listCarts"
                          [ngClass]="{'out-of-stock-row': cart.stock_suficiente === false}">
                        <ng-container *ngIf="cart.id !== 'SHIPPING'">
                           <!-- img -->
                           <td class="tp-cart-img" [ngClass]="{'opacity-50': cart.stock_suficiente === false}">
                             <a [routerLink]="['/producto/'+cart.product.slug]">
                               <img [src]="cart.product.imagen" alt="">
                             </a>
                           </td>

                           <!-- title -->
                           <td class="tp-cart-title">
                             <a [routerLink]="['/producto/'+cart.product.slug]">
                               {{cart.product.title}}
                             </a>

                             <!-- Aviso de envío gratis por producto -->
                             <ng-container *ngIf="cart.product && cart.product.cost == 1 && cart.stock_suficiente !== false">
                               <br>
                               <span class="badge bg-success" style="font-size: 0.85rem; margin-top: 5px;">✓ Envío GRATIS</span>
                             </ng-container>

                             <!-- INDICADOR DE STOCK -->
                             <ng-container *ngIf="cart.stock_suficiente === false">
                               <br>
                               <div class="alert alert-danger stock-alert" style="margin-top: 8px; padding: 8px 12px; font-size: 0.9rem; max-width: 400px;">
                                 <i class="fas fa-times-circle"></i>
                                 <span *ngIf="cart.stock_disponible === 0">
                                   <strong>SIN STOCK</strong> - Este producto no se incluirá en tu compra
                                 </span>
                                 <span *ngIf="cart.stock_disponible > 0">
                                   <strong>STOCK INSUFICIENTE</strong> - Solo quedan {{cart.stock_disponible}} unidades
                                 </span>
                               </div>
                             </ng-container>

                             <!-- Stock suficiente pero bajo -->
                             <ng-container *ngIf="cart.stock_suficiente && cart.stock_disponible > 0 && cart.stock_disponible <= 5">
                               <br>
                               <div class="alert alert-warning stock-alert" style="margin-top: 8px; padding: 8px 12px; font-size: 0.85rem; max-width: 400px;">
                                 <i class="fas fa-exclamation-triangle"></i>
                                 <span>Solo quedan <strong>{{cart.stock_disponible}}</strong> unidades disponibles</span>
                               </div>
                             </ng-container>

                             <div style="margin-left: 20px;">
                               <ng-container *ngIf="cart.product_variation">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• {{cart.product_variation.attribute.name}}: {{cart.product_variation.propertie?.name || cart.product_variation.value_add}}</span>
                                 <ng-container *ngIf="cart.product_variation.variation_father">
                                   <br>
                                   <span class="cartmini__quantity mx-2">• {{cart.product_variation.variation_father.attribute.name}}: {{cart.product_variation.variation_father.propertie?.name || cart.product_variation.variation_father.value_add}}
                                   </span>
                                 </ng-container>
                               </ng-container>
                               <ng-container *ngIf="cart.code_cupon">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• Cupón: {{cart.code_cupon}}</span>
                               </ng-container>
                               <ng-container *ngIf="cart.code_discount">
                                 <br>
                                 <span class="cartmini__quantity mx-2">• Campaña: {{cart.code_discount}}</span>
                               </ng-container>
                               <ng-container *ngIf="cart.code_discount || cart.code_cupon">
                                 <br>
                                 <span class="text-primary mx-2">• Descuento: {{cart.discount}} {{cart.type_discount == 1 ? '%' : cart.currency}}</span>
                                 <br>
                                 <span class="text-danger mx-2">• Precio original: <del>{{cart.price_unit ?? cart.subtotal}} {{cart.currency}}</del></span>
                               </ng-container>
                             </div>
                           </td>

                           <!-- price -->
                           <td class="tp-cart-price" [ngClass]="{'text-muted': cart.stock_suficiente === false}">
                             <span>{{cart.subtotal}} {{cart.currency}}</span>
                             <span *ngIf="cart.stock_suficiente === false" class="d-block text-danger small">No disponible</span>
                           </td>

                           <!-- quantity -->
                           <td class="tp-cart-quantity">
                              <div class="tp-product-quantity mt-10 mb-10">
                                 <span class="tp-cart-minus"
                                       (click)="minusQuantity(cart)"
                                       [class.disabled]="cart.quantity <= 1 || cart.stock_suficiente === false">
                                    <svg width="10" height="2" viewBox="0 0 10 2" fill="none" xmlns="http://www.w3.org/2000/svg">
                                       <path d="M1 1H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                 </span>
                                 <input class="tp-cart-input" type="text" [value]="cart.quantity" readonly
                                        [ngClass]="{'text-muted': cart.stock_suficiente === false}">
                                 <span class="tp-cart-plus"
                                       (click)="plusQuantity(cart)"
                                       [class.disabled]="!cart.stock_suficiente || cart.quantity >= cart.stock_disponible || cart.stock_suficiente === false">
                                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                       <path d="M5 1V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                       <path d="M1 5H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                 </span>
                              </div>
                           </td>

                           <td class="tp-cart-price" [ngClass]="{'text-muted': cart.stock_suficiente === false}">
                             <span>
                               <span *ngIf="cart.stock_suficiente !== false">{{cart.total}} {{cart.currency}}</span>
                               <span *ngIf="cart.stock_suficiente === false" class="text-danger">-</span>
                             </span>
                           </td>

                           <!-- action -->
                           <td class="tp-cart-action">
                              <button class="tp-cart-action-btn" (click)="deleteCart(cart)">
                                 <svg width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M9.53033 1.53033C9.82322 1.23744 9.82322 0.762563 9.53033 0.46967C9.23744 0.176777 8.76256 0.176777 8.46967 0.46967L5 3.93934L1.53033 0.46967C1.23744 0.176777 0.762563 0.176777 0.46967 0.46967C0.176777 0.762563 0.176777 1.23744 0.46967 1.53033L3.93934 5L0.46967 8.46967C0.176777 8.76256 0.176777 9.23744 0.46967 9.53033C0.762563 9.82322 1.23744 9.82322 1.53033 9.53033L5 6.06066L8.46967 9.53033C8.76256 9.82322 9.23744 9.82322 9.53033 9.53033C9.82322 9.23744 9.82322 8.76256 9.53033 8.46967L6.06066 5L9.53033 1.53033Z" fill="currentColor"/>
                                 </svg>
                                 <span><br>Eliminar</span>
                              </button>
                           </td>
                        </ng-container>
                      </tr>
                    </tbody>
                  </table>
              </div>

              <!-- MENSAJE INFORMATIVO SOBRE PRODUCTOS SIN STOCK -->
              <div *ngIf="hasStockIssues && availableProducts.length > 0" class="alert alert-info mb-4" style="padding: 15px; border-radius: 5px;">
                <i class="fas fa-info-circle"></i>
                <strong>Información:</strong> Tienes {{outOfStockProducts.length}} producto(s) sin stock en tu carrito.
                Puedes continuar con la compra de los {{availableProducts.length}} producto(s) disponibles.
                Los productos sin stock se ignorarán automáticamente.
              </div>

              <!-- MENSAJE SI TODOS LOS PRODUCTOS ESTÁN SIN STOCK -->
              <div *ngIf="hasStockIssues && availableProducts.length === 0" class="alert alert-danger mb-4" style="padding: 15px; border-radius: 5px;">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Atención:</strong> Ninguno de los productos en tu carrito tiene stock disponible.
                Por favor elimínalos o espera a que vuelvan a estar disponibles.
              </div>

              <div class="tp-cart-bottom">
                 <div class="row align-items-end">
                    <div class="col-xl-6 col-md-8">
                       <div class="tp-cart-coupon">
                          <form action="#">
                             <div class="tp-cart-coupon-input-box">
                                <label>Cupón:</label>
                                <div class="tp-cart-coupon-input d-flex align-items-center">
                                   <input type="text" name="code_cupon" [(ngModel)]="code_cupon" placeholder="Colocar codigo del cupon">
                                   <button type="button" (click)="applyCupon()">Aplicar</button>
                                </div>
                             </div>
                          </form>
                       </div>
                    </div>
                 </div>
              </div>
           </div>

           <div class="col-xl-3 col-lg-4 col-md-6">
              <div class="tp-cart-checkout-wrapper">

                  <!-- ========== RESUMEN DE COMPRA ========== -->

                  <!-- Información de productos sin stock -->
                  <div *ngIf="hasStockIssues" class="alert alert-warning mb-3" style="font-size: 0.85rem;">
                    <strong>Resumen solo de productos disponibles</strong>
                    <br>
                    <small>{{outOfStockProducts.length}} producto(s) sin stock no se incluyen en el total</small>
                  </div>

                  <!-- Subtotal original -->
                  <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                    <span>Subtotal</span>
                    <span>{{ subtotalOriginal | number:'1.2-2' }} {{ currency }}</span>
                  </div>

                  <!-- Descuentos aplicados -->
                  <div *ngIf="discountTotal > 0" class="tp-cart-checkout-shipping">
                    <h4 class="tp-cart-checkout-shipping-title text-success">Descuentos</h4>

                    <div *ngIf="globalCouponCode" class="mb-2">
                      <div class="d-flex justify-content-between">
                        <span class="text-muted">Cupón: <strong>{{ globalCouponCode }}</strong></span>
                      </div>
                      <div *ngIf="discountType" class="text-muted small">
                        ({{ discountType.value }}{{ discountType.isPercentage ? '%' : ' ' + currency }} de descuento)
                      </div>
                    </div>

                    <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between text-success">
                      <span><strong>Total descontado:</strong></span>
                      <span><strong>- {{ discountTotal | number:'1.2-2' }} {{ currency }}</strong></span>
                    </div>

                    <hr class="my-2">

                    <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                      <span>Subtotal con descuento:</span>
                      <span>{{ subtotalAfterDiscount | number:'1.2-2' }} {{ currency }}</span>
                    </div>
                  </div>

                  <!-- Si no hay descuentos -->
                  <div *ngIf="discountTotal === 0" class="text-muted text-center mb-3" style="font-size: 0.9rem;">
                    No hay descuentos aplicados
                  </div>

                  <hr>

                  <!-- Sección de envío -->
                  <div class="tp-cart-checkout-shipping">
                    <h4 class="tp-cart-checkout-shipping-title">Envío</h4>

                    <!-- Mensaje de envío gratis por monto -->
                    <div *ngIf="qualifiesForFreeShippingByAmount && !hasFreeShipping" class="alert alert-success mb-3">
                      <strong>¡Felicitaciones!</strong><br>
                      Tu compra supera los <strong>${{ freeShippingThreshold | number:'1.0-0' }}</strong><br>
                      <strong>¡Envío GRATIS!</strong>
                    </div>

                    <!-- Mensaje de envío gratis por productos -->
                    <div *ngIf="hasFreeShipping" class="alert alert-success mb-3">
                      <strong>¡Envío GRATIS!</strong> Todos los productos disponibles tienen envío gratis.
                    </div>

                    <!-- Mensaje para alcanzar envío gratis (solo si está cerca) -->
                    <div *ngIf="!hasFreeShippingOverall && (freeShippingThreshold - subtotalAfterDiscount) <= 50000 && (freeShippingThreshold - subtotalAfterDiscount) > 0"
                         class="alert alert-info mb-3">
                      <strong>¡Estás cerca!</strong><br>
                      Agregando <strong>${{ (freeShippingThreshold - subtotalAfterDiscount) | number:'1.2-2' }}</strong> más, tendrás envío gratis
                    </div>

                    <!-- Mensaje mixto (algunos productos con envío gratis) -->
                    <div *ngIf="hasSomeFreeShipping && !hasFreeShipping && !qualifiesForFreeShippingByAmount" class="alert alert-info mb-3">
                      <strong>Nota:</strong> Algunos productos tienen envío gratis, pero otros no.
                    </div>

                    <!-- Formulario de provincia (solo si NO hay envío gratis) -->
                    <form *ngIf="!hasFreeShippingOverall" #provinciaForm="ngForm" (ngSubmit)="applyCosto()">
                      <label for="provincia">Seleccionar provincia:</label>
                      <div class="d-flex align-items-center">
                        <select
                          [(ngModel)]="selectedProvinceCode"
                          name="provincia"
                          id="provincia"
                          required
                          class="form-select"
                          #provinciaControl="ngModel"
                        >
                          <option [ngValue]="null" disabled>-- SELECCIONAR --</option>
                          <option *ngFor="let prov of provincias" [ngValue]="prov.code">
                            {{ prov.name }}
                          </option>
                        </select>

                        <button
                          type="submit"
                          class="btn btn-primary ms-2"
                          [disabled]="provinciaForm.invalid"
                        >
                          Aplicar
                        </button>

                        <button
                          *ngIf="selectedProvinceCode"
                          type="button"
                          (click)="removeProvincia()"
                          class="btn btn-danger ms-2"
                        >
                          <span aria-hidden="true">×</span>
                        </button>
                      </div>

                      <div *ngIf="provinciaControl.invalid && provinciaControl.touched" class="text-danger mt-1">
                        La provincia es obligatoria.
                      </div>
                    </form>
                  </div>

                  <!-- Costo de envío -->
                  <div *ngIf="!hasFreeShippingOverall && shippingCostValue > 0" class="tp-cart-checkout-total d-flex align-items-center justify-content-between">
                    <span>Costo de envío</span>
                    <span>{{ shippingCostValue | number:'1.2-2' }} {{ currency }}</span>
                  </div>

                  <!-- Mostrar envío gratis si aplica -->
                  <div *ngIf="hasFreeShippingOverall" class="tp-cart-checkout-total d-flex align-items-center justify-content-between text-success">
                    <span>Costo de envío</span>
                    <span><strong>GRATIS</strong></span>
                  </div>

                  <hr>

                  <!-- TOTAL FINAL -->
                  <div class="tp-cart-checkout-total d-flex align-items-center justify-content-between" style="font-size: 1rem;">
                    <span><strong>TOTAL A PAGAR</strong></span>
                    <span><strong>{{ grandTotal | number:'1.2-2' }} {{ currency }}</strong></span>
                  </div>

                  <!-- BOTÓN DE CHECKOUT ACTUALIZADO -->
                  <div class="tp-cart-checkout-proceed">
                    <button
                      class="tp-cart-checkout-btn w-100"
                      (click)="proceedToCheckout()"
                      [disabled]="(!hasFreeShippingOverall && !selectedProvinceCode) || availableProducts.length === 0"
                      [ngClass]="{'disabled-btn': (!hasFreeShippingOverall && !selectedProvinceCode) || availableProducts.length === 0}"
                    >
                      <span *ngIf="availableProducts.length > 0">
                        Continuar con {{availableProducts.length}} producto(s)
                      </span>
                      <span *ngIf="availableProducts.length === 0">
                        No hay productos disponibles
                      </span>
                    </button>

                    <!-- Mensajes de validación -->
                    <div *ngIf="availableProducts.length === 0" class="text-danger text-center mt-2">
                      <i class="fas fa-exclamation-circle"></i>
                      No hay productos con stock disponible en tu carrito.
                    </div>

                    <div *ngIf="availableProducts.length > 0 && !hasFreeShippingOverall && !selectedProvinceCode" class="text-warning text-center mt-2">
                      <i class="fas fa-exclamation-triangle"></i>
                      Selecciona una provincia para calcular el envío.
                    </div>

                    <div *ngIf="hasStockIssues && availableProducts.length > 0" class="text-info text-center mt-2">
                      <i class="fas fa-info-circle"></i>
                      Los productos sin stock se ignorarán automáticamente.
                    </div>
                  </div>

              </div>
           </div>
        </div>
     </div>
  </section>
  <!-- cart area end -->

</main>
